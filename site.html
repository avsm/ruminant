<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCaml Thicket</title>
    
    <!-- Atom/RSS Feeds -->
    <link rel="alternate" type="application/atom+xml" title="OCaml Ecosystem - Weekly Summaries" href="feeds/weekly.xml">
    <!-- Group-specific feeds will be dynamically added -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #000;
            --bg-secondary: #111;
            --bg-tertiary: #222;
            --border-color: #333;
            --text-primary: #00ff88;
            --text-secondary: #ddd;
            --text-muted: #bbb;
            --text-dim: #ccc;
            --link-color: #999;
            --priority-color: #ffddee;
            --eco-active-bg: #003300;
        }
        
        :root.light-mode {
            --bg-primary: #f4f1e8;
            --bg-secondary: #ebe6d9;
            --bg-tertiary: #ddd5c3;
            --border-color: #b8b0a0;
            --text-primary: #0a1a0a;
            --text-secondary: #1a2f1a;
            --text-muted: #2a4f2a;
            --text-dim: #4a6f4a;
            --link-color: #506850;
            --priority-color: #1a3f1a;
            --eco-active-bg: #c8c0a8;
        }
        
        body { 
            font-family: 'JetBrains Mono', 'SF Mono', 'Roboto Mono', 'Fira Code', 'Consolas', monospace;
            line-height: 1.3;
            color: var(--text-primary);
            background: var(--bg-primary);
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        /* Top header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        
        /* Desktop: hide row wrappers */
        .header-row-1,
        .header-row-2 {
            display: contents;
        }
        
        /* Hide mobile-only elements on desktop */
        .repo-dropdown-header {
            display: none;
        }
        
        .header-title {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: bold;
            margin-left: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .header-separator {
            color: var(--text-muted);
            font-size: 13px;
            margin: 0 10px;
            opacity: 0.3;
        }
        
        .header-groups {
            display: flex;
            align-items: center;
            gap: 0;
            margin-left: 5px;
        }
        
        .repo-view-indicator {
            display: flex;
            align-items: center;
            margin-left: 10px;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .repo-view-indicator:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
        }
        
        .repo-icon {
            width: 12px;
            height: 12px;
            margin-right: 6px;
            fill: var(--text-muted);
        }
        
        .repo-close {
            margin-left: 6px;
            width: 10px;
            height: 10px;
            fill: var(--text-muted);
            opacity: 0.7;
        }
        
        .repo-view-indicator:hover .repo-icon,
        .repo-view-indicator:hover .repo-close {
            fill: var(--text-primary);
        }
        
        .group-tab {
            color: var(--text-muted);
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            letter-spacing: 1px;
            opacity: 0.7;
        }
        
        .group-tab::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 12px;
            background: var(--border-color);
            opacity: 0.3;
        }
        
        .group-tab:first-child::before {
            display: none;
        }
        
        .group-tab:hover {
            color: var(--text-secondary);
            opacity: 0.9;
            background: var(--bg-tertiary);
        }
        
        .group-tab.active {
            color: var(--text-primary);
            opacity: 1;
            background: none;
            font-weight: 600;
        }
        
        .group-tab.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 15%;
            right: 15%;
            height: 1px;
            background: var(--text-primary);
            opacity: 0.8;
        }
        
        
        /* Repository Dropdown */
        .repo-dropdown-container {
            position: relative;
            margin-left: auto;
            margin-right: 10px;
        }
        
        .repo-dropdown-toggle {
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            letter-spacing: 1px;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
            user-select: none;
        }
        
        .repo-dropdown-toggle:hover {
            color: var(--text-primary);
        }
        
        .dropdown-arrow {
            font-size: 8px;
            transition: transform 0.2s;
        }
        
        .repo-dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .repo-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
        }
        
        .repo-dropdown.show {
            display: block;
        }
        
        .repo-dropdown-content {
            padding: 8px;
        }
        
        .repo-org-group {
            margin-bottom: 12px;
        }
        
        .repo-org-name {
            color: var(--text-primary);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .repo-item {
            display: block;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 11px;
            font-family: monospace;
            padding: 2px 8px;
            border-radius: 2px;
            transition: all 0.15s;
        }
        
        .repo-item:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        
        
        /* Sidebar with Timeline */
        .sidebar {
            width: 160px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            margin-top: 40px;
            height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .timeline-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .year-overview {
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .year-selector-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            gap: 12px;
        }
        
        .year-nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            transition: all 0.15s;
            opacity: 0.6;
            font-family: inherit;
        }
        
        .year-nav-btn:hover:not(:disabled) {
            color: var(--text-primary);
            opacity: 1;
        }
        
        .year-nav-btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }
        
        .year-display {
            color: var(--text-primary);
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }
        
        .weeks-bar {
            display: flex;
            gap: 1px;
            height: 20px;
            background: var(--bg-secondary);
            padding: 2px;
            border-radius: 2px;
        }
        
        .week-tick {
            flex: 1;
            background: var(--border-color);
            border-radius: 1px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        
        .week-tick.has-data {
            background: var(--text-muted);
            opacity: 0.4;
        }
        
        .week-tick.has-activity {
            background: var(--text-muted);
            opacity: 0.6;
        }
        
        .week-tick:hover {
            background: var(--text-primary);
            opacity: 0.8;
        }
        
        .week-tick.current {
            background: var(--text-primary);
            opacity: 1;
            box-shadow: 0 0 4px var(--text-primary);
        }
        
        .week-tick.viewing {
            background: var(--text-primary);
            opacity: 1;
        }
        
        .week-tick-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 2px;
            border: 1px solid var(--border-color);
            font-size: 9px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            margin-bottom: 4px;
            z-index: 1000;
        }
        
        .week-tick:hover .week-tick-tooltip {
            opacity: 1;
        }
        
        .timeline-weeks {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .timeline-week {
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            border-left: 2px solid transparent;
            margin-bottom: 2px;
        }
        
        .timeline-week:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--border-color);
        }
        
        .timeline-week.active {
            background: var(--eco-active-bg);
            border-left-color: var(--text-primary);
        }
        
        .timeline-week.no-data {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .timeline-week-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
        }
        
        .timeline-week.active .timeline-week-label {
            color: var(--text-primary);
            opacity: 1;
        }
        
        .timeline-week-dates {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .timeline-week.active .timeline-week-dates {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .timeline-year {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            opacity: 0.5;
        }
        
        .timeline-week.active .timeline-year {
            opacity: 0.8;
        }
        
        .timeline-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: var(--text-primary);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .timeline-week.has-activity .timeline-indicator {
            opacity: 0.3;
        }
        
        .timeline-week.active .timeline-indicator {
            opacity: 1;
        }
        
        /* Timeline scrollbar styling */
        .timeline-weeks::-webkit-scrollbar {
            width: 4px;
        }
        
        .timeline-weeks::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        .timeline-weeks::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
        
        .timeline-weeks::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            margin-top: 40px;
            overflow-y: auto;
            height: calc(100vh - 40px);
            background: var(--bg-primary);
        }
        
        
        .content-body {
            padding: 0;
        }
        
        .week-section {
            margin-bottom: 30px;
            padding: 0;
            scroll-margin-top: 40px;
        }
        
        .week-section.inactive-week {
            margin-bottom: 8px;
        }
        
        .week-section.inactive-week .week-header-main {
            margin-bottom: 0;
            padding: 4px 0 4px 20px;
        }
        
        .week-header-main {
            padding: 8px 0 12px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: monospace;
            background: none;
            position: relative;
        }
        
        .week-header-main::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20px;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, var(--border-color), transparent);
            opacity: 0.5;
        }
        
        .week-title-main {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .week-title-main.inactive-week {
            opacity: 0.4;
            color: var(--text-muted);
        }
        
        .week-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
            flex-shrink: 0;
        }
        
        .week-icon svg {
            width: 100%;
            height: 100%;
            fill: var(--text-primary);
        }
        
        .week-date-range {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 400;
            opacity: 0.7;
        }
        
        .week-repos-summary {
            border-left: 2px solid var(--border-color);
            padding: 0 0 6px 20px;
            margin-bottom: 8px;
            font-family: monospace;
            position: relative;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        
        .repos-list {
            color: var(--text-muted);
            font-size: 11px;
            opacity: 0.7;
            line-height: 1.4;
        }
        
        .repos-list-truncated {
            max-height: 2.8em;
            overflow: hidden;
            position: relative;
        }
        
        .repos-list-truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 50px;
            height: 1.4em;
            background: linear-gradient(to right, transparent, var(--bg-primary));
        }
        
        .reveal-button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-family: monospace;
            font-size: 10px;
            padding: 2px 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .reveal-button:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }
        
        .org-group {
            display: inline;
            margin-left: 12px;
        }
        
        .org-group:first-child {
            margin-left: 0;
        }
        
        .org-name {
            color: var(--text-muted);
            opacity: 0.8;
            text-decoration: none;
        }
        
        .org-name:hover {
            text-decoration: underline;
        }
        
        .repo-link {
            color: var(--link-color);
            text-decoration: none;
            margin-left: 2px;
        }
        
        .repo-link:hover {
            text-decoration: underline;
        }
        
        .week-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 0 20px 20px 20px;
            font-size: 11px;
            line-height: 1.5;
        }
        
        .week-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .content-block {
            color: var(--text-secondary);
        }
        
        .content-label {
            color: var(--text-secondary);
            font-weight: normal;
            margin-bottom: 12px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
            padding-bottom: 4px;
            display: flex;
            position: relative;
            align-items: center;
            gap: 6px;
        }
        
        .content-label::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, var(--text-secondary), transparent);
            opacity: 0.4;
        }
        
        .content-label svg {
            width: 14px;
            height: 14px;
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 1.5;
            opacity: 0.8;
        }
        
        
        .repo-inline {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 600;
        }
        
        .repo-inline:hover {
            text-decoration: underline;
        }
        
        .commit-range,
        .commit-link {
            color: var(--text-muted);
            font-size: 10px;
            text-decoration: none;
            opacity: 0.7;
            margin-left: 4px;
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            transition: all 0.2s;
        }
        
        .commit-range:hover,
        .commit-link:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        
        .diff-icon {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }
        
        code {
            font-family: 'JetBrains Mono', 'SF Mono', 'Roboto Mono', 'Fira Code', 'Consolas', monospace;
            font-size: inherit;
        }
        
        /* Special styling for internal group navigation links */
        .group-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 400;
            border: 1px solid var(--border-color);
            padding: 0px 2px;
            border-radius: 1px;
            font-size: 0.80em;
            background: var(--bg-tertiary);
        }
        
        

        .group-link:hover {
            background: var(--bg-secondary);
            border-color: var(--text-muted);
            color: var(--text-primary);
            text-decoration: none !important;
        }
        
        
        
        /* Alternative approach with just icon prefix for cleaner look */
        
        
        .section-summary {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 2px solid var(--bg-tertiary);
            font-style: italic;
            line-height: 1.4;
        }
        
        .section-summary a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .section-summary a:hover {
            text-decoration: underline;
        }
        
        .section-summary .user-link {
            font-weight: 600;
            font-style: italic;
            position: relative;
            transition: all 0.2s ease;
        }
        
        /* Interactive hover effect for user links */
        .user-link:hover {
            opacity: 1;
            background: rgba(100, 149, 237, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            margin: -1px -4px;
        }
        
        /* Enhanced user tooltip container */
        .user-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            max-width: 280px;
        }
        
        /* Show tooltip on parent span hover */
        .user-link-wrapper:hover .user-tooltip {
            opacity: 1;
        }
        
        .user-tooltip-content {
            display: block;
            position: relative;
        }
        
        .user-tooltip-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            float: left;
            margin-right: 10px;
            margin-bottom: 4px;
            background: var(--bg-tertiary);
        }
        
        .user-tooltip-avatar[data-lazy="true"] {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--bg-secondary) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Back button for repo view */
        .back-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .back-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-primary);
        }
        
        .user-tooltip-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 2px;
            line-height: 1.3;
        }
        
        .user-tooltip-username {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .user-tooltip-details {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 4px;
        }
        
        /* Arrow for enhanced tooltip */
        .user-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--border-color);
        }
        
        .user-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-1px);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--bg-secondary);
        }
        
        
        .content-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        /* Markdown list styling */
        .markdown-list {
            margin: 4px 0 8px 0;
            padding-left: 0;
            list-style: none;
        }
        
        .markdown-list li {
            position: relative;
            padding-left: 12px;
            line-height: 1.2;
            padding-bottom: 0.8em;
        }
        
        .markdown-list li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--text-dim);
            font-size: 10px;
        }
        
        .content-text a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .content-text a:visited {
            color: var(--link-color);
        }
        
        .content-text a:hover {
            text-decoration: underline;
        }
        
        /* Achievement styling */
        .achievement {
            color: #00ffff;
        }
        
        :root.light-mode .achievement {
            color: #cc6600;
            font-weight: 600;
        }
        
        /* Linked achievements */
        a.achievement-link {
            text-decoration: none;
            cursor: pointer;
        }
        
        a.achievement-link:hover .achievement {
            text-decoration: underline;
            opacity: 0.9;
        }
        
        /* Special styling for issue/PR links */
        .content-text a.issue-link,
        .section-summary a.issue-link {
            font-weight: normal;
            font-style: italic;
            position: relative;
            white-space: nowrap;
            opacity: 0.85;
            padding-right: 8px;
        }
        
        .content-text a.issue-link::after,
        .section-summary a.issue-link::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 7px;
            height: 7px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath d='M5 0 L8 0 L8 3 M8 0 L2 6' stroke='%23999' stroke-width='1.2' fill='none' opacity='0.6'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* Tooltip styling for issue links */
        a.issue-link[title]:hover::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            margin-bottom: 4px;
        }
        
        
        
        .priority-text {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .priority-text .markdown-list li::before {
            color: var(--text-dim);
            content: '▸';
        }
        
        
        .priority-text a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .priority-text a:visited {
            color: var(--link-color);
        }
        
        .priority-text a:hover {
            text-decoration: underline;
        }
        
        .priority-text a.issue-link {
            font-weight: normal;
            font-style: italic;
            position: relative;
            white-space: nowrap;
            opacity: 0.85;
            padding-right: 8px;
        }
        
        .priority-text a.issue-link::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 7px;
            height: 7px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath d='M5 0 L8 0 L8 3 M8 0 L2 6' stroke='%23999' stroke-width='1.2' fill='none' opacity='0.6'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .contributor-text {
            color: var(--text-secondary);
        }
        
        .contributor-text .markdown-list li::before {
            content: '·';
            font-size: 14px;
            top: -2px;
        }
        
        .contributor-text a {
            color: var(--link-color);
            text-decoration: none;
        }
        
        .contributor-text a:visited {
            color: var(--link-color);
        }
        
        .contributor-text a:hover {
            text-decoration: underline;
        }
        
        .contributor-text a.issue-link {
            font-weight: normal;
            font-style: italic;
            position: relative;
            white-space: nowrap;
            opacity: 0.85;
            padding-right: 8px;
        }
        
        .contributor-text a.issue-link::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 7px;
            height: 7px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath d='M5 0 L8 0 L8 3 M8 0 L2 6' stroke='%23999' stroke-width='1.2' fill='none' opacity='0.6'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .content-section {
            border: 1px solid #333;
            background: #111;
        }
        
        .section-header {
            background: #222;
            border-bottom: 1px solid #333;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #00ff00;
            font-weight: bold;
            font-family: inherit;
            user-select: none;
        }
        
        .section-toggle {
            color: #666;
            font-size: 10px;
        }
        
        .section-content {
            padding: 15px;
            display: block;
        }
        
        .section-content.collapsed {
            display: none;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
        }
        
        .column-header {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            position: relative;
        }
        
        .column-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, var(--border-color), transparent);
            opacity: 0.4;
        }
        
        .priority-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #330033;
            background: #110011;
        }
        
        .priority-header {
            color: var(--priority-color);
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 4px;
            position: relative;
        }
        
        .priority-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, var(--priority-color), transparent);
            opacity: 0.3;
        }
        
        .priority-content {
            color: #ccc;
            font-size: 10px;
            line-height: 1.4;
        }
        
        .detail-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #222;
            background: #111;
        }
        
        .detail-header {
            color: var(--link-color);
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            position: relative;
        }
        
        .detail-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, var(--link-color), transparent);
            opacity: 0.3;
        }
        
        .detail-content {
            color: #aaa;
            font-size: 10px;
            line-height: 1.4;
        }
        
        .priority {
            color: #ff0066;
            font-weight: bold;
        }
        
        .achievement {
            color: #00ffff;
        }
        
        .repo-content a {
            color: #0099ff;
            text-decoration: none;
        }
        
        .repo-content a:hover {
            text-decoration: underline;
        }
        
        .loading, .error {
            text-align: center;
            padding: 50px;
            color: var(--text-muted);
            font-size: 12px;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.8em;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .error {
            color: var(--priority-color);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            margin: 20px;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            padding: 0 15px;
        }
        
        .status-left {
            display: flex;
            align-items: center;
        }
        
        .status-left a {
            color: var(--link-color);
            text-decoration: none;
            margin: 0 2px;
        }
        
        .status-left a:hover {
            text-decoration: underline;
        }
        
        .status-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-action {
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text-muted);
            transition: color 0.3s;
        }
        
        .status-action:hover {
            color: var(--text-primary);
        }
        
        .mode-action {
            font-size: 16px;
        }
        
        /* Feeds Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
        
        .modal-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .modal-close {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 24px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .feed-item-link {
            display: block;
            text-decoration: none;
            margin-bottom: 10px;
        }
        
        .feed-item-link:last-child {
            margin-bottom: 0;
        }
        
        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        
        .feed-item-link:hover .feed-item {
            background: var(--bg-primary);
            border-color: var(--text-primary);
        }
        
        .feed-info {
            flex: 1;
        }
        
        .feed-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .feed-desc {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .feed-icon {
            padding: 8px;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        
        .feed-item-link:hover .feed-icon {
            color: var(--text-primary);
        }
        
        /* Tablet breakpoint - single column layout */
        @media screen and (max-width: 1024px) {
            .week-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                width: 140px;
            }
        }
        
        /* Mobile breakpoint */
        @media screen and (max-width: 768px) {
            body {
                overflow: auto;
            }
            
            .container {
                flex-direction: column;
                height: auto;
            }
            
            /* Make header mobile-friendly with two rows */
            .header {
                position: sticky;
                height: auto;
                padding: 8px 5px;
                flex-direction: column;
                align-items: stretch;
            }
            
            /* First row: title and mode toggle */
            .header-row-1 {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 8px;
            }
            
            /* Second row: groups and repo button */
            .header-row-2 {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .header-title {
                font-size: 14px;
                margin-left: 10px;
                flex-shrink: 0;
            }
            
            .header-separator {
                margin: 0 4px;
                font-size: 11px;
            }
            
            .header-groups {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                flex: 1;
                gap: 2px;
                -webkit-overflow-scrolling: touch;
            }
            
            .group-tab {
                flex-shrink: 0;
                font-size: 10px;
                padding: 4px 6px;
                white-space: nowrap;
            }
            
            /* Dynamic abbreviations for longer group names on mobile */
            /* These can be added dynamically via JavaScript if needed */
            
            .repo-dropdown-container {
                flex-shrink: 0;
            }
            
            .repo-dropdown-toggle {
                font-size: 11px;
                padding: 6px 10px;
                background: var(--bg-tertiary);
                border-radius: 3px;
            }
            
            /* Mobile modal for repo dropdown */
            .repo-dropdown {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--bg-primary);
                border: none;
                border-radius: 0;
                box-shadow: none;
                max-width: none;
                max-height: none;
                overflow-y: auto;
                z-index: 9999;
                display: none;
                flex-direction: column;
            }
            
            .repo-dropdown.show {
                display: flex;
            }
            
            .repo-dropdown-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px;
                border-bottom: 1px solid var(--border-color);
                background: var(--bg-secondary);
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .repo-dropdown-title {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .repo-dropdown-close {
                font-size: 24px;
                color: var(--text-muted);
                cursor: pointer;
                padding: 0 5px;
                line-height: 1;
            }
            
            .repo-dropdown-content {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
            }
            
            
            /* Hide sidebar on mobile */
            .sidebar {
                display: none;
            }
            
            /* Full width main content */
            .main-content {
                margin-top: 0;
                height: auto;
                overflow-y: visible;
            }
            
            /* Make ecosystem tabs scrollable */
            .content-header {
                height: auto;
                padding: 8px;
                overflow-x: auto;
            }
            
            .ecosystem-nav {
                min-width: max-content;
            }
            
            .eco-tab {
                font-size: 10px;
                padding: 5px 10px;
            }
            
            /* Adjust week sections for mobile */
            .week-section {
                padding: 15px;
            }
            
            .week-title-main {
                font-size: 12px;
            }
            
            .week-subtitle {
                font-size: 10px;
            }
            
            .week-content {
                padding: 15px 0;
                font-size: 12px;
                gap: 15px;
            }
            
            .content-label {
                font-size: 11px;
            }
            
            .repo-label {
                font-size: 13px;
                margin-top: 10px;
            }
            
            .content-text,
            .priority-text,
            .contributor-text {
                font-size: 12px;
            }
            
            /* Hide status bar on mobile */
            .status-bar {
                display: none;
            }
        }
        
        /* Small mobile */
        @media screen and (max-width: 480px) {
            .week-section {
                padding: 10px;
            }
            
            .week-content {
                padding: 10px 0;
            }
            
            .header-title {
                letter-spacing: 1px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-row-1">
            <div class="header-title">OCAML.SYS</div>
        </div>
        <div class="header-row-2">
            <div class="header-separator">::</div>
            <div class="header-groups" id="header-groups">
                <div class="group-tab active" data-group="all">[ALL]</div>
                <!-- Groups will be dynamically added here -->
            </div>
            <div id="repo-view-indicator" class="repo-view-indicator" style="display: none;"></div>
            <div class="repo-dropdown-container">
                <div class="repo-dropdown-toggle" onclick="toggleRepoDropdown()">
                    <span>REPOS</span>
                    <span class="dropdown-arrow">▼</span>
                </div>
                <div class="repo-dropdown" id="repo-dropdown">
                    <div class="repo-dropdown-header">
                        <div class="repo-dropdown-title">Select Repository</div>
                        <div class="repo-dropdown-close" onclick="closeRepoDropdown()">×</div>
                    </div>
                    <div class="repo-dropdown-content" id="repo-dropdown-content">
                        <!-- Repository list will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="timeline-container">
                <div class="year-overview" id="year-overview"></div>
                <div class="timeline-weeks" id="timeline-weeks"></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-body">
                <div id="loading" class="loading">INITIALIZING FEED...</div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="main-display"></div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-left">
            Generated by <a href="https://github.com/avsm/thicket" target="_blank">Thicket</a> and Claude, by <a href="https://anil.recoil.org" target="_blank">Anil Madhavapeddy</a>
        </div>
        <div class="status-right">
            <div class="status-action feed-action" onclick="showFeeds()" title="RSS/Atom Feeds">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 11a9 9 0 0 1 9 9"/>
                    <path d="M4 4a16 16 0 0 1 16 16"/>
                    <circle cx="5" cy="19" r="1"/>
                </svg>
            </div>
            <div class="status-action mode-action" onclick="toggleTheme()" title="Toggle Theme">
                <span id="mode-icon-bottom">◐</span>
            </div>
        </div>
    </div>

    <script>
        let indexData = null;
        let groupsData = null;
        let allWeekData = {}; // Cache for loaded week data
        let loadingWeeks = {}; // Track which weeks are currently being loaded
        let usersData = {};
        let currentEcosystem = 'all';
        let currentWeekKey = null;
        let currentYear = new Date().getFullYear();
        
        // Theme management
        function detectSystemTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }
        
        function setTheme(theme) {
            const root = document.documentElement;
            const iconBottom = document.getElementById('mode-icon-bottom');
            
            if (theme === 'light') {
                root.classList.add('light-mode');
                iconBottom.textContent = '☀';
                localStorage.setItem('theme', 'light');
            } else {
                root.classList.remove('light-mode');
                iconBottom.textContent = '☾';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        function toggleTheme() {
            const isLight = document.documentElement.classList.contains('light-mode');
            setTheme(isLight ? 'dark' : 'light');
        }
        
        // Initialize theme on page load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const theme = savedTheme || detectSystemTheme();
            setTheme(theme);
            
            // Listen for system theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', e => {
                    if (!localStorage.getItem('theme')) {
                        setTheme(e.matches ? 'light' : 'dark');
                    }
                });
            }
        }
        
        function getCommitRangeLink(repo) {
            if (!repo.start_commit || !repo.end_commit) {
                return '';
            }
            
            // Get short hashes (first 7 characters)
            const startHash = repo.start_commit.substring(0, 7);
            const endHash = repo.end_commit.substring(0, 7);
            
            // Check if start and end are the same (single commit)
            if (repo.start_commit === repo.end_commit) {
                const commitUrl = `https://github.com/${repo.repo_full}/commit/${repo.start_commit}`;
                return ` <a href="${commitUrl}" target="_blank" class="commit-link" title="View commit ${startHash}">${getDiffIcon()}</a>`;
            } else {
                // Multiple commits - use compare URL
                const compareUrl = `https://github.com/${repo.repo_full}/compare/${startHash}..${endHash}`;
                return ` <a href="${compareUrl}" target="_blank" class="commit-range" title="View commits ${startHash}..${endHash}">${getDiffIcon()}</a>`;
            }
        }
        
        function getDiffIcon() {
            return `<svg class="diff-icon" viewBox="0 0 16 16">
                <path d="M1.5 1.75V13.5h13V1.75H1.5zM.75 1.5c0-.966.784-1.75 1.75-1.75h11c.966 0 1.75.784 1.75 1.75v12c0 .966-.784 1.75-1.75 1.75h-11A1.75 1.75 0 0 1 .75 13.5V1.5zM8 4a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0V4.75A.75.75 0 0 1 8 4zm-3 1.5c.414 0 .75.336.75.75v3.5c0 .414-.336.75-.75.75s-.75-.336-.75-.75v-3.5c0-.414.336-.75.75-.75zm6 0c.414 0 .75.336.75.75v3.5c0 .414-.336.75-.75.75s-.75-.336-.75-.75v-3.5c0-.414.336-.75.75-.75z" fill="currentColor"/>
            </svg>`;
        }
        
        function getSectionIcon(label) {
            const icons = {
                'overview': '',
                'new features': '<svg viewBox="0 0 24 24"><path d="M12 2 L15.5 8.5 L22 9 L17 14 L18.5 20.5 L12 17 L5.5 20.5 L7 14 L2 9 L8.5 8.5 Z" stroke-width="1.5" fill="none"/><circle cx="12" cy="12" r="3"/></svg>',
                'cross-repo work': '<svg viewBox="0 0 24 24"><path d="M4 6 L4 18 L10 18 M14 6 L20 6 L20 18 L14 18"/><path d="M10 12 L14 12 M11 9 L13 12 L11 15"/></svg>',
                'key projects': '<svg viewBox="0 0 24 24"><rect x="5" y="4" width="14" height="5"/><rect x="5" y="11" width="14" height="5"/><rect x="5" y="18" width="14" height="2"/></svg>',
                'discussions': '<svg viewBox="0 0 24 24"><path d="M21 11 C21 7 17 4 12 4 C7 4 3 7 3 11 C3 14 5 16 8 17 L8 20 L12 17 C17 17 21 14 21 11 Z"/></svg>',
                'emerging trends': '<svg viewBox="0 0 24 24"><path d="M4 20 L8 16 L12 18 L16 10 L20 14"/><path d="M16 10 L20 10 L20 14"/></svg>',
                'good first issues': '<svg viewBox="0 0 24 24"><path d="M12 2 L15 9 L22 9 L17 14 L19 21 L12 17 L5 21 L7 14 L2 9 L9 9 Z"/></svg>',
                'contributors': '<svg viewBox="0 0 24 24"><circle cx="9" cy="8" r="3"/><circle cx="15" cy="8" r="3"/><path d="M4 18 C4 14 6 12 9 12 C12 12 12 12 15 12 C18 12 20 14 20 18"/></svg>',
                'activity': '<svg viewBox="0 0 24 24"><path d="M3 12 L7 8 L11 14 L15 6 L19 12 L21 10"/></svg>',
                'ongoing': '<svg viewBox="0 0 24 24"><path d="M12 2 L12 12 L17 17"/><circle cx="12" cy="12" r="9"/></svg>'
            };
            return icons[label.toLowerCase()] || '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="10"/></svg>';
        }

        function renderMarkdown(text) {
            if (!text) return '';
            
            // Handle inline code blocks with backticks
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Substitute __RUMINANT:groupname__ tokens with clickable links
            text = text.replace(/__RUMINANT:([^_]+)__/g, function(match, groupName) {
                const groupDisplayName = {
                    'core': 'core',
                    'tools': 'tools',
                    'ecosystem': 'ecosystem',
                    'oxcaml': 'oxcaml'
                }[groupName] || groupName;
                
                return `<a href="javascript:void(0)" onclick="handleGroupClick('${groupName}')" class="group-link" data-group="${groupName}" title="View detailed ${groupDisplayName} group activity">${groupDisplayName}</a>`;
            });
            
            // Convert GitHub issue/PR links with special styling
            // Handle both [#123](url) and [user/repo#123](url) formats
            text = text.replace(/\[([^\/\]]+\/[^#\]]+#\d+)\]\((https:\/\/github\.com\/[^)]+)\)/g, function(match, linkText, url) {
                // Extract parts from linkText like "user/repo#123"
                const parts = linkText.match(/^([^\/]+)\/([^#]+)#(\d+)$/);
                if (parts) {
                    const [, user, repo, issueNum] = parts;
                    // Just show the issue number, but keep full reference in tooltip
                    return `<a href="${url}" target="_blank" class="issue-link issue-full" title="${linkText}">#${issueNum}</a>`;
                }
                return `<a href="${url}" target="_blank" class="issue-link issue-full">${linkText}</a>`;
            });
            
            // Handle simple issue/PR number format [#123](url) for both /issues/ and /pull/ URLs
            text = text.replace(/\[#(\d+)\]\((https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/(issues|pull)\/\d+[^)]*)\)/g, 
                '<a href="$2" target="_blank" class="issue-link issue-simple" title="$3/$4#$1">#$1</a>');
            
            // Detect user mentions in regular links
            text = text.replace(/\[(@[^\]]+)\]\(([^)]+)\)/g, function(match, userText, url) {
                // Extract username from URL if it's a GitHub URL
                let username = userText.replace('@', '');
                const githubMatch = url.match(/github\.com\/([^\/]+)/);
                if (githubMatch) {
                    username = githubMatch[1];
                }
                
                // Get user data if available
                const userData = usersData[username] || {};
                
                // Build the enhanced tooltip HTML
                let tooltipHtml = '<div class="user-tooltip"><div class="user-tooltip-content">';
                
                // Add avatar placeholder - will load on hover
                if (userData.avatar_url) {
                    tooltipHtml += `<img data-src="${userData.avatar_url}" alt="${username}" class="user-tooltip-avatar" data-lazy="true">`;
                } else {
                    tooltipHtml += `<div class="user-tooltip-avatar"></div>`;
                }
                
                // Name and username
                if (userData.name) {
                    tooltipHtml += `<div class="user-tooltip-name">${userData.name}</div>`;
                    tooltipHtml += `<div class="user-tooltip-username">@${username}</div>`;
                } else {
                    tooltipHtml += `<div class="user-tooltip-name">@${username}</div>`;
                }
                
                // Additional details
                let details = [];
                if (userData.company) {
                    details.push(userData.company);
                }
                if (userData.location) {
                    details.push(userData.location);
                }
                if (details.length > 0) {
                    tooltipHtml += `<div class="user-tooltip-details">${details.join(' • ')}</div>`;
                }
                
                tooltipHtml += '</div></div>';
                
                return `<span class="user-link-wrapper" style="position: relative; display: inline-block;"><a href="${url}" target="_blank" class="user-link">${userText}</a>${tooltipHtml}</span>`;
            });
            
            // Convert regular markdown links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
                // Check if it's a user profile link
                if (url.includes('github.com/') && url.split('/').length === 4) {
                    const username = url.split('/').pop();
                    // Get user data if available
                    const userData = usersData[username] || {};
                    
                    // Build the enhanced tooltip HTML
                    let tooltipHtml = '<div class="user-tooltip"><div class="user-tooltip-content">';
                    
                    // Add avatar placeholder - will load on hover
                    if (userData.avatar_url) {
                        tooltipHtml += `<img data-src="${userData.avatar_url}" alt="${username}" class="user-tooltip-avatar" data-lazy="true">`;
                    } else {
                        tooltipHtml += `<div class="user-tooltip-avatar"></div>`;
                    }
                    
                    // Name and username
                    if (userData.name) {
                        tooltipHtml += `<div class="user-tooltip-name">${userData.name}</div>`;
                        tooltipHtml += `<div class="user-tooltip-username">@${username}</div>`;
                    } else {
                        tooltipHtml += `<div class="user-tooltip-name">@${username}</div>`;
                    }
                    
                    // Additional details
                    let details = [];
                    if (userData.company) {
                        details.push(userData.company);
                    }
                    if (userData.location) {
                        details.push(userData.location);
                    }
                    if (details.length > 0) {
                        tooltipHtml += `<div class="user-tooltip-details">${details.join(' • ')}</div>`;
                    }
                    
                    tooltipHtml += '</div></div>';
                    
                    // If linkText is just @username and we have full name data, use the full name
                    let displayText = linkText;
                    if (linkText === `@${username}` && userData.name) {
                        displayText = userData.name;
                    }
                    
                    return `<span class="user-link-wrapper" style="position: relative; display: inline-block;"><a href="${url}" target="_blank" class="user-link">${displayText}</a>${tooltipHtml}</span>`;
                }
                return `<a href="${url}" target="_blank">${linkText}</a>`;
            });
            
            // Resolve unresolved GitHub user links (already in HTML format)
            // Handle cases like <a href="https://github.com/username">@username</a>
            text = text.replace(/<a href="https:\/\/github\.com\/([^"]+)"[^>]*>@([^<]+)<\/a>/g, function(match, urlUsername, linkUsername) {
                // Use the username from URL as it's more reliable
                const username = urlUsername;
                const userData = usersData[username] || {};
                
                // If we have full name data, use it instead of @username
                let displayText = `@${linkUsername}`;
                if (userData.name) {
                    displayText = userData.name;
                }
                
                // Build the enhanced tooltip HTML
                let tooltipHtml = '<div class="user-tooltip"><div class="user-tooltip-content">';
                
                // Add avatar placeholder - will load on hover
                if (userData.avatar_url) {
                    tooltipHtml += `<img data-src="${userData.avatar_url}" alt="${username}" class="user-tooltip-avatar" data-lazy="true">`;
                } else {
                    tooltipHtml += `<div class="user-tooltip-avatar"></div>`;
                }
                
                // Name and username
                if (userData.name) {
                    tooltipHtml += `<div class="user-tooltip-name">${userData.name}</div>`;
                    tooltipHtml += `<div class="user-tooltip-username">@${username}</div>`;
                } else {
                    tooltipHtml += `<div class="user-tooltip-name">@${username}</div>`;
                }
                
                // Additional details
                let details = [];
                if (userData.company) {
                    details.push(userData.company);
                }
                if (userData.location) {
                    details.push(userData.location);
                }
                if (details.length > 0) {
                    tooltipHtml += `<div class="user-tooltip-details">${details.join(' • ')}</div>`;
                }
                
                tooltipHtml += '</div></div>';
                
                return `<span class="user-link-wrapper" style="position: relative; display: inline-block;"><a href="https://github.com/${username}" target="_blank" class="user-link">${displayText}</a>${tooltipHtml}</span>`;
            });
            
            text = text.replace(/\*\*([^*]+)\*\*/g, '<span class="achievement">$1</span>');
            
            // Handle lists - split by newlines and process
            const lines = text.split('\n');
            let inList = false;
            let processedLines = [];
            
            lines.forEach(line => {
                if (line.match(/^- /)) {
                    if (!inList) {
                        processedLines.push('<ul class="markdown-list">');
                        inList = true;
                    }
                    processedLines.push('<li>' + line.substring(2) + '</li>');
                } else {
                    if (inList) {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    if (line.trim()) {
                        processedLines.push(line + '<br>');
                    }
                }
            });
            
            if (inList) {
                processedLines.push('</ul>');
            }
            
            // Link achievements to their related issues
            const html = processedLines.join('');
            return linkAchievements(html);
        }
        
        function linkAchievements(html) {
            // Process achievements in list items to link them with the first issue link in the same item
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Find all list items
            tempDiv.querySelectorAll('li').forEach(li => {
                // Check if this list item has an achievement span
                const achievement = li.querySelector('.achievement');
                if (achievement && !achievement.parentElement.matches('a')) {
                    // Find the first issue link in the same list item
                    const issueLink = li.querySelector('a.issue-link, a[href*="/issues/"], a[href*="/pull/"]');
                    if (issueLink) {
                        // Wrap the achievement in a link to the same URL
                        const link = document.createElement('a');
                        link.href = issueLink.href;
                        link.target = '_blank';
                        link.className = 'achievement-link';
                        link.title = issueLink.title || issueLink.textContent;
                        
                        // Replace the achievement span with the linked version
                        achievement.parentNode.insertBefore(link, achievement);
                        link.appendChild(achievement);
                    }
                }
            });
            
            return tempDiv.innerHTML;
        }
        
        // Wrapper function for onclick handlers that need async calls
        function handleGroupClick(groupName) {
            switchToGroup(groupName).catch(console.error);
        }
        
        async function switchToGroup(groupName) {
            // Update active tab
            document.querySelectorAll('.group-tab').forEach(t => {
                t.classList.remove('active');
            });
            const activeTab = document.querySelector(`.group-tab[data-group="${groupName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                
                // Switch ecosystem and refresh content
                currentEcosystem = groupName;
                populateTimeline();
                await displayAllWeeks();
                
                // Update URL
                updateURL();
            }
        }
        
        // URL management functions
        function updateURL(replaceOnly = false) {
            const params = new URLSearchParams();
            
            // Handle repository view
            if (currentRepoView) {
                params.set('repo', currentRepoView);
                if (currentWeekKey) {
                    params.set('week', currentWeekKey);
                }
            } else {
                // Handle regular timeline view
                if (currentEcosystem && currentEcosystem !== 'all') {
                    params.set('group', currentEcosystem);
                }
                if (currentWeekKey) {
                    params.set('week', currentWeekKey);
                }
            }
            
            const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
            
            // Use replaceState for scroll updates to avoid flooding history
            if (replaceOnly) {
                const state = currentRepoView ? 
                    { repo: currentRepoView, week: currentWeekKey } : 
                    { ecosystem: currentEcosystem, week: currentWeekKey };
                window.history.replaceState(state, '', newURL);
            } else {
                const state = currentRepoView ? 
                    { repo: currentRepoView, week: currentWeekKey } : 
                    { ecosystem: currentEcosystem, week: currentWeekKey };
                window.history.pushState(state, '', newURL);
            }
        }
        
        function parseURL() {
            const params = new URLSearchParams(window.location.search);
            const ecosystem = params.get('group') || 'all';
            const week = params.get('week');
            
            return { ecosystem, week };
        }
        
        async function restoreStateFromURL() {
            const { ecosystem, week } = parseURL();
            
            // Set the ecosystem
            if (ecosystem !== currentEcosystem) {
                currentEcosystem = ecosystem;
                
                // Update active tab
                document.querySelectorAll('.group-tab').forEach(t => {
                    t.classList.remove('active');
                });
                const activeTab = document.querySelector(`.group-tab[data-group="${ecosystem}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
            
            // Set the week
            if (week) {
                currentWeekKey = week;
                // Scroll to the week after content is loaded
                setTimeout(() => {
                    const weekElement = document.getElementById(`week-${week}`);
                    if (weekElement) {
                        weekElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
            
            // Refresh the display
            populateTimeline();
            await displayAllWeeks();
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                currentEcosystem = event.state.ecosystem || 'all';
                currentWeekKey = event.state.week || null;
                restoreStateFromURL().catch(console.error);
            }
        });
        
        async function initSystem() {
            updateStatus('LOADING INDEX...');
            try {
                const [indexResp, groupsResp, usersResp] = await Promise.all([
                    fetch('index.json'),
                    fetch('groups.json'),
                    fetch('users.json')
                ]);
                
                if (!indexResp.ok || !groupsResp.ok) throw new Error('FEED CORRUPTED');
                
                indexData = await indexResp.json();
                groupsData = await groupsResp.json();
                
                // Load users data - fallback to empty object if not available
                if (usersResp.ok) {
                    usersData = await usersResp.json();
                } else {
                    usersData = {};
                }
                
                // Dynamically generate group tabs and feed links
                generateDynamicGroups();
                generateDynamicFeeds();
                
                // Remove loadAllWeekData() - we'll lazy load instead
                await initInterface();
                updateStatus('FEED ACTIVE');
            } catch (error) {
                showError('SYSTEM ERROR: ' + error.message);
            }
        }
        
        async function loadWeekData(weekKey) {
            // Return cached data if already loaded
            if (allWeekData[weekKey]) {
                return allWeekData[weekKey];
            }
            
            // Return existing promise if already loading
            if (loadingWeeks[weekKey]) {
                return await loadingWeeks[weekKey];
            }
            
            // Start loading and cache the promise
            loadingWeeks[weekKey] = (async () => {
                try {
                    const response = await fetch(`weeks/${weekKey}.json`);
                    if (response.ok) {
                        const weekData = await response.json();
                        allWeekData[weekKey] = weekData;
                        return weekData;
                    }
                    return null;
                } catch (error) {
                    console.warn(`Failed to load week ${weekKey}:`, error);
                    return null;
                } finally {
                    // Clean up loading promise
                    delete loadingWeeks[weekKey];
                }
            })();
            
            return await loadingWeeks[weekKey];
        }
        
        async function initInterface() {
            // Restore state from URL first
            const { ecosystem, week } = parseURL();
            if (ecosystem) {
                currentEcosystem = ecosystem;
                // Update active tab
                document.querySelectorAll('.group-tab').forEach(t => {
                    t.classList.remove('active');
                });
                const activeTab = document.querySelector(`.group-tab[data-group="${ecosystem}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }
            if (week) {
                currentWeekKey = week;
            }
            
            populateTimeline();
            setupGroupTabs();
            setupScrollHandler();
            
            document.getElementById('loading').style.display = 'none';
            
            await displayAllWeeks();
            
            // Handle URL parameters (including repo parameter)
            handleUrlParameters();
            
            // Scroll to week if specified in URL
            if (currentWeekKey) {
                setTimeout(() => {
                    const weekElement = document.getElementById(`week-${currentWeekKey}`);
                    if (weekElement) {
                        weekElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }
        
        function populateTimeline() {
            const timelineWeeks = document.getElementById('timeline-weeks');
            timelineWeeks.innerHTML = '';
            
            let weeks;
            if (currentEcosystem === 'all') {
                weeks = indexData.weeks.filter(w => 
                    w.year === currentYear && (w.has_weekly_summary || w.groups.length > 0)
                );
            } else {
                weeks = groupsData[currentEcosystem].weeks.filter(w => {
                    const weekInfo = indexData.weeks.find(iw => iw.week === w.week && iw.year === currentYear);
                    return weekInfo && w.has_content;
                });
            }
            
            // Populate year overview
            populateYearOverview();
            
            weeks.forEach(week => {
                const weekElement = createTimelineWeek(week);
                timelineWeeks.appendChild(weekElement);
            });
        }
        
        function populateYearOverview() {
            const yearOverview = document.getElementById('year-overview');
            yearOverview.innerHTML = '';
            
            // Get available years from data
            const availableYears = new Set();
            indexData.weeks.forEach(w => {
                availableYears.add(w.year);
            });
            const yearsArray = Array.from(availableYears).sort((a, b) => a - b);
            
            // Create array of all 52/53 weeks
            const allWeeksInYear = [];
            for (let i = 1; i <= 52; i++) {
                allWeeksInYear.push(i);
            }
            
            // Create year selector container
            const selectorContainer = document.createElement('div');
            selectorContainer.className = 'year-selector-container';
            
            // Create prev button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'year-nav-btn';
            prevBtn.innerHTML = '‹';
            prevBtn.onclick = async () => {
                const currentIndex = yearsArray.indexOf(currentYear);
                if (currentIndex > 0) {
                    currentYear = yearsArray[currentIndex - 1];
                    populateTimeline();
                    await displayAllWeeks();
                }
            };
            // Disable if at first year
            if (yearsArray[0] === currentYear) {
                prevBtn.disabled = true;
            }
            selectorContainer.appendChild(prevBtn);
            
            // Create year display
            const yearDisplay = document.createElement('div');
            yearDisplay.className = 'year-display';
            yearDisplay.textContent = currentYear;
            selectorContainer.appendChild(yearDisplay);
            
            // Create next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'year-nav-btn';
            nextBtn.innerHTML = '›';
            nextBtn.onclick = async () => {
                const currentIndex = yearsArray.indexOf(currentYear);
                if (currentIndex < yearsArray.length - 1) {
                    currentYear = yearsArray[currentIndex + 1];
                    populateTimeline();
                    await displayAllWeeks();
                }
            };
            // Disable if at last year
            if (yearsArray[yearsArray.length - 1] === currentYear) {
                nextBtn.disabled = true;
            }
            selectorContainer.appendChild(nextBtn);
            
            yearOverview.appendChild(selectorContainer);
            
            // Create weeks bar container
            const weeksBar = document.createElement('div');
            weeksBar.className = 'weeks-bar';
            
            // Get data about which weeks have content for the selected year
            const weeksWithData = new Set();
            const weeksWithActivity = new Set();
            
            if (currentEcosystem === 'all') {
                indexData.weeks.forEach(w => {
                    if (w.year === currentYear && (w.has_weekly_summary || w.groups.length > 0)) {
                        weeksWithData.add(w.week);
                        if (w.activity_level > 0.5) {
                            weeksWithActivity.add(w.week);
                        }
                    }
                });
            } else if (groupsData[currentEcosystem]) {
                groupsData[currentEcosystem].weeks.forEach(w => {
                    const weekInfo = indexData.weeks.find(iw => iw.week === w.week && iw.year === currentYear);
                    if (weekInfo && w.has_content) {
                        weeksWithData.add(w.week);
                        if (weekInfo.activity_level > 0.5) {
                            weeksWithActivity.add(w.week);
                        }
                    }
                });
            }
            
            // Create tick for each week
            allWeeksInYear.forEach(weekNum => {
                const tick = document.createElement('div');
                tick.className = 'week-tick';
                tick.dataset.week = weekNum;
                
                if (weeksWithData.has(weekNum)) {
                    tick.classList.add('has-data');
                    if (weeksWithActivity.has(weekNum)) {
                        tick.classList.add('has-activity');
                    }
                    
                    // Make clickable
                    tick.onclick = () => {
                        const weekKey = `${currentYear}-${weekNum}`;
                        scrollToWeek(weekKey);
                    };
                }
                
                // Add tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'week-tick-tooltip';
                tooltip.textContent = `Week ${weekNum}`;
                tick.appendChild(tooltip);
                
                weeksBar.appendChild(tick);
            });
            
            yearOverview.appendChild(weeksBar);
        }
        
        function createTimelineWeek(week) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'timeline-week';
            weekDiv.dataset.weekKey = week.week_key;
            
            const weekInfo = indexData.weeks.find(w => w.week_key === week.week_key);
            const hasData = weekInfo && (weekInfo.has_weekly_summary || weekInfo.groups.length > 0);
            const hasActivity = weekInfo && weekInfo.activity_level > 0.5;
            
            if (hasData) {
                weekDiv.onclick = () => scrollToWeek(week.week_key);
                if (hasActivity) {
                    weekDiv.classList.add('has-activity');
                }
            } else {
                weekDiv.classList.add('no-data');
            }
            
            // Parse dates
            const [startStr, endStr] = week.week_range.split(' to ');
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            
            // Week label
            const weekLabel = document.createElement('div');
            weekLabel.className = 'timeline-week-label';
            weekLabel.textContent = `week ${week.week}`;
            weekDiv.appendChild(weekLabel);
            
            // Date range
            const datesDiv = document.createElement('div');
            datesDiv.className = 'timeline-week-dates';
            
            // Check if dates are valid
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                datesDiv.textContent = `W${week.week}`;
            } else {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const startMonth = monthNames[startDate.getMonth()];
                const endMonth = monthNames[endDate.getMonth()];
                const startDay = startDate.getDate();
                const endDay = endDate.getDate();
                
                if (startMonth === endMonth) {
                    datesDiv.textContent = `${startMonth} ${startDay}-${endDay}`;
                } else {
                    datesDiv.textContent = `${startMonth} ${startDay}-${endMonth} ${endDay}`;
                }
            }
            weekDiv.appendChild(datesDiv);
            
            // Year
            const yearDiv = document.createElement('div');
            yearDiv.className = 'timeline-year';
            yearDiv.textContent = week.year;
            weekDiv.appendChild(yearDiv);
            
            // Activity indicator
            const indicator = document.createElement('div');
            indicator.className = 'timeline-indicator';
            weekDiv.appendChild(indicator);
            
            return weekDiv;
        }
        
        function setupGroupTabs() {
            document.querySelectorAll('.group-tab').forEach(tab => {
                tab.onclick = async () => {
                    // Exit repository view if currently viewing one
                    if (currentRepoView) {
                        await exitRepoView();
                        return; // exitRepoView will handle the group switching
                    }
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.group-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Update current ecosystem
                    currentEcosystem = tab.dataset.group;
                    currentWeekKey = null; // Reset week when changing groups
                    populateTimeline();
                    await displayAllWeeks();
                    
                    // Update repository dropdown if it's open
                    if (repoDropdownOpen) {
                        populateRepoDropdown();
                    }
                    
                    // Update URL
                    updateURL();
                };
            });
        }
        
        function setupScrollHandler() {
            const mainContent = document.querySelector('.main-content');
            mainContent.addEventListener('scroll', () => {
                updateTimelineHighlight();
            });
        }
        
        function scrollToWeek(weekKey) {
            const weekElement = document.getElementById(`week-${weekKey}`);
            console.log('scrollToWeek called with:', weekKey, 'Element found:', !!weekElement);
            if (weekElement) {
                weekElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                currentWeekKey = weekKey;
                updateURL();
                console.log('Scrolled to week:', weekKey);
            } else {
                console.error('Week element not found for ID:', `week-${weekKey}`);
            }
        }
        
        function updateTimelineHighlight() {
            const mainContent = document.querySelector('.main-content');
            const weekSections = document.querySelectorAll('.week-section');
            
            let visibleWeekKey = null;
            let visibleWeekNum = null;
            
            weekSections.forEach(section => {
                const rect = section.getBoundingClientRect();
                const mainRect = mainContent.getBoundingClientRect();
                
                if (rect.top <= mainRect.top + 100 && rect.bottom > mainRect.top + 100) {
                    visibleWeekKey = section.dataset.weekKey;
                    
                    // Extract week number from week key (format: YYYY-WW)
                    if (visibleWeekKey) {
                        const parts = visibleWeekKey.split('-');
                        if (parts.length === 2) {
                            visibleWeekNum = parseInt(parts[1]);
                        }
                    }
                    
                    // Update global currentWeekKey if it changed
                    if (currentWeekKey !== visibleWeekKey) {
                        currentWeekKey = visibleWeekKey;
                        updateURL(true); // Use replaceState for scroll updates
                    }
                }
            });
            
            if (visibleWeekKey) {
                // Update timeline week highlighting
                document.querySelectorAll('.timeline-week').forEach(week => {
                    week.classList.remove('active');
                });
                
                const activeWeek = document.querySelector(`.timeline-week[data-week-key="${visibleWeekKey}"]`);
                if (activeWeek) {
                    activeWeek.classList.add('active');
                    
                    // Scroll timeline to show active week if needed
                    const timelineContainer = document.getElementById('timeline-weeks');
                    const weekRect = activeWeek.getBoundingClientRect();
                    const containerRect = timelineContainer.getBoundingClientRect();
                    
                    if (weekRect.top < containerRect.top || weekRect.bottom > containerRect.bottom) {
                        activeWeek.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                // Update year overview highlighting
                document.querySelectorAll('.week-tick').forEach(tick => {
                    tick.classList.remove('viewing', 'current');
                });
                
                if (visibleWeekNum) {
                    const activeTick = document.querySelector(`.week-tick[data-week="${visibleWeekNum}"]`);
                    if (activeTick) {
                        activeTick.classList.add('viewing', 'current');
                    }
                }
            }
        }
        
        function toggleReposList(listId, button) {
            const list = document.getElementById(listId);
            const isTruncated = list.classList.contains('repos-list-truncated');
            
            if (isTruncated) {
                list.classList.remove('repos-list-truncated');
                button.textContent = 'show less';
            } else {
                list.classList.add('repos-list-truncated');
                button.textContent = 'show all';
            }
        }
        
        let repoDropdownOpen = false;
        
        function toggleRepoDropdown() {
            const dropdown = document.getElementById('repo-dropdown');
            const toggle = document.querySelector('.repo-dropdown-toggle');
            
            if (repoDropdownOpen) {
                dropdown.classList.remove('show');
                toggle.classList.remove('active');
                repoDropdownOpen = false;
                // Re-enable body scroll on mobile
                if (window.innerWidth <= 768) {
                    document.body.style.overflow = '';
                }
            } else {
                populateRepoDropdown();
                dropdown.classList.add('show');
                toggle.classList.add('active');
                repoDropdownOpen = true;
                // Disable body scroll on mobile when modal is open
                if (window.innerWidth <= 768) {
                    document.body.style.overflow = 'hidden';
                }
            }
        }
        
        function closeRepoDropdown() {
            const dropdown = document.getElementById('repo-dropdown');
            const toggle = document.querySelector('.repo-dropdown-toggle');
            dropdown.classList.remove('show');
            toggle.classList.remove('active');
            repoDropdownOpen = false;
            // Re-enable body scroll on mobile
            if (window.innerWidth <= 768) {
                document.body.style.overflow = '';
            }
        }
        
        // Cache for loaded repository data
        let repoDataCache = {};
        let currentRepoView = null;
        
        function populateRepoDropdown() {
            const content = document.getElementById('repo-dropdown-content');
            const allRepos = new Set();
            
            // Collect all repositories from current ecosystem
            if (allWeekData) {
                Object.values(allWeekData).forEach(weekData => {
                    if (weekData.repositories) {
                        weekData.repositories.forEach(repo => {
                            if (hasRepoActivity(repo)) {
                                if (currentEcosystem === 'all' || 
                                    (groupsData[currentEcosystem] && 
                                     groupsData[currentEcosystem].repositories.includes(repo.repo_full))) {
                                    allRepos.add(repo.repo_full);
                                }
                            }
                        });
                    }
                });
            }
            
            // Group repositories by organization
            const reposByOrg = {};
            Array.from(allRepos).forEach(repoFull => {
                const [org, name] = repoFull.split('/');
                if (!reposByOrg[org]) {
                    reposByOrg[org] = [];
                }
                reposByOrg[org].push(name);
            });
            
            // Generate HTML with clickable items that show repo summaries
            let html = '';
            Object.entries(reposByOrg).sort().forEach(([org, repos]) => {
                html += `
                    <div class="repo-org-group">
                        <div class="repo-org-name">${org}</div>
                        ${repos.sort().map(name => 
                            `<a href="javascript:void(0)" onclick="showRepoSummary('${org}/${name}')" class="repo-item">${name}</a>`
                        ).join('')}
                    </div>
                `;
            });
            
            content.innerHTML = html || '<div style="padding: 8px; color: var(--text-muted);">No repositories found</div>';
        }
        
        async function showRepoSummary(repoFullName) {
            // Close the dropdown
            closeRepoDropdown();
            
            // Update URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('repo', repoFullName);
            window.history.pushState({ repo: repoFullName }, '', newUrl);
            
            // Show loading state
            const display = document.getElementById('main-display');
            const originalContent = display.innerHTML;
            currentRepoView = repoFullName;
            
            // Update header to show repository view indicator
            updateRepositoryViewIndicator(repoFullName);
            
            display.innerHTML = `
                <div class="repo-summary-view">
                    <div class="loading-indicator">Loading repository data...</div>
                </div>
            `;
            
            try {
                // Load repository data (check cache first)
                let repoData;
                if (repoDataCache[repoFullName]) {
                    repoData = repoDataCache[repoFullName];
                } else {
                    const safeFilename = repoFullName.replace('/', '_');
                    const response = await fetch(`repositories/${safeFilename}.json`);
                    if (response.ok) {
                        repoData = await response.json();
                        repoDataCache[repoFullName] = repoData;
                    } else {
                        throw new Error('Repository data not found');
                    }
                }
                
                // Render repository summary
                renderRepoSummary(repoData);
                
            } catch (error) {
                console.error('Failed to load repository data:', error);
                display.innerHTML = `
                    <div class="repo-summary-view">
                        <div class="error">Failed to load repository data</div>
                    </div>
                `;
            }
        }
        
        function renderRepoSummary(repoData) {
            const display = document.getElementById('main-display');
            
            // Sort summaries by week (newest first) 
            const sortedSummaries = repoData.summaries.sort((a, b) => {
                const keyA = `${a.year}-${String(a.week).padStart(2, '0')}`;
                const keyB = `${b.year}-${String(b.week).padStart(2, '0')}`;
                return keyB.localeCompare(keyA);
            });
            
            // Start without header - repository info is now in the top bar indicator
            let html = '';
            
            // Use same structure as main timeline
            html += '<div class="weeks-grid">';
            
            // Render each week's summary using the same structure as weekly view
            sortedSummaries.forEach(summary => {
                // Create weekKey for this week
                const weekKey = `${summary.year}-${String(summary.week).padStart(2, '0')}`;
                
                // Format the date range
                const formatWeekDate = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const day = date.getDate();
                    const suffix = day === 1 || day === 21 || day === 31 ? 'st' : 
                                  day === 2 || day === 22 ? 'nd' : 
                                  day === 3 || day === 23 ? 'rd' : 'th';
                    return `${day}${suffix} ${months[date.getMonth()]} ${date.getFullYear()}`;
                };
                
                let formattedRange = '';
                if (summary.week_range) {
                    const [startDate, endDate] = summary.week_range.split(' to ');
                    if (startDate && endDate) {
                        const startFormatted = formatWeekDate(startDate);
                        const endFormatted = formatWeekDate(endDate);
                        
                        const startParts = startFormatted.split(' ');
                        const endParts = endFormatted.split(' ');
                        formattedRange = startParts[1] === endParts[1] && startParts[2] === endParts[2] ? 
                            `${startParts[0]} - ${endParts[0]} ${endParts[1]} ${endParts[2]}` : 
                            `${startFormatted} - ${endFormatted}`;
                    }
                }
                
                // Check if there's any content for this week
                const hasContent = summary.overall_activity || summary.ongoing_projects || 
                                 summary.new_features || summary.notable_discussions || 
                                 summary.contributors || summary.good_first_issues;
                
                if (!hasContent) {
                    // Compact inactive week - no week-content div at all
                    html += `
                        <div class="week-section inactive-week" id="week-${weekKey}" data-week-key="${weekKey}">
                            <div class="week-header-main">
                                <div class="week-title-main inactive-week">
                                    <div class="week-icon">
                                        <svg viewBox="0 0 24 24" style="opacity: 1;">
                                            <!-- Circle with X - clear inactive indicator -->
                                            <circle cx="12" cy="12" r="10" fill="none" stroke="var(--text-muted)" stroke-width="2"/>
                                            <path d="M8 8l8 8M16 8l-8 8" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    W${summary.week}.${summary.year}
                                </div>
                                <div class="week-date-range">${formattedRange}</div>
                            </div>
                        </div>
                    `;
                    return; // Skip to next week
                }
                
                // Active week with content
                html += `
                    <div class="week-section" id="week-${weekKey}" data-week-key="${weekKey}">
                        <div class="week-header-main">
                            <div class="week-title-main">
                                <div class="week-icon">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                    </svg>
                                </div>
                                W${summary.week}.${summary.year}
                            </div>
                            <div class="week-date-range">${formattedRange}</div>
                        </div>
                        <div class="week-content">
                `;
                
                // Build left column content
                let leftColumn = '<div class="content-block">';
                let rightColumn = '<div class="content-block">';
                
                // Add overall activity to left column (skip brief summary for repo view)
                    if (summary.overall_activity) {
                        leftColumn += `
                            <div class="content-label">${getSectionIcon('activity')}activity</div>
                            <div class="content-text">${renderMarkdown(summary.overall_activity)}</div>
                        `;
                }
                
                // Add ongoing projects to left column
                    if (summary.ongoing_projects) {
                        leftColumn += `
                            <div class="content-label">${getSectionIcon('ongoing')}ongoing projects</div>
                            <div class="content-text">${renderMarkdown(summary.ongoing_projects)}</div>
                        `;
                }
                
                // Add new features to left column (after activity)
                    if (summary.new_features) {
                        leftColumn += `
                            <div class="content-label">${getSectionIcon('new features')}new features</div>
                            <div class="content-text">${renderMarkdown(summary.new_features)}</div>
                        `;
                }
                
                // Add discussions to right column
                    if (summary.notable_discussions) {
                        rightColumn += `
                            <div class="content-label">${getSectionIcon('discussions')}discussions</div>
                            <div class="content-text">${renderMarkdown(summary.notable_discussions)}</div>
                        `;
                }
                
                // Add contributors to right column
                    if (summary.contributors) {
                        rightColumn += `
                            <div class="content-label">${getSectionIcon('contributors')}contributors</div>
                            <div class="content-text">${renderMarkdown(summary.contributors)}</div>
                        `;
                }
                
                // Add issues if available
                    if (summary.good_first_issues) {
                        rightColumn += `
                            <div class="content-label">${getSectionIcon('issues')}good first issues</div>
                            <div class="content-text">${renderMarkdown(summary.good_first_issues)}</div>
                        `;
                }
                
                leftColumn += '</div>';
                rightColumn += '</div>';
                
                html += leftColumn + rightColumn;
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>'; // Close weeks-grid
            display.innerHTML = html;
            
            // Setup timeline for repo view
            console.log('Setting up repo timeline and scroll handler');
            populateRepoTimeline(repoData);
            
            // Setup scroll handler after content is rendered
            setTimeout(() => {
                console.log('Setting up repo scroll handler (delayed)');
                
                // Verify week sections exist with data attributes
                const weekSections = document.querySelectorAll('.week-section[data-week-key]');
                console.log('Found week sections with data-week-key:', weekSections.length);
                weekSections.forEach((section, i) => {
                    console.log(`  Week ${i}: ${section.dataset.weekKey}`);
                });
                
                setupRepoScrollHandler();
                
                // Trigger initial detection
                const mainContent = document.querySelector('.main-content');
                if (mainContent && mainContent._repoScrollHandler) {
                    console.log('Triggering initial scroll detection');
                    mainContent._repoScrollHandler();
                }
                
                // Scroll to week if specified in URL
                if (currentWeekKey) {
                    console.log('Scrolling to week:', currentWeekKey);
                    const weekElement = document.getElementById(`week-${currentWeekKey}`);
                    if (weekElement) {
                        weekElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.log('Week element not found:', `week-${currentWeekKey}`);
                    }
                }
            }, 100);
        }
        
        async function exitRepoView() {
            currentRepoView = null;
            
            // Clear URL parameter
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('repo');
            newUrl.searchParams.delete('week'); // Also clear week when exiting repo view
            window.history.pushState({}, '', newUrl);
            
            // Remove repository view indicator
            updateRepositoryViewIndicator(null);
            
            // Clean up repo scroll handler
            cleanupRepoScrollHandler();
            
            // Return to the timeline view
            await displayAllWeeks();
        }
        
        // Close dropdown when clicking outside (desktop only)
        document.addEventListener('click', function(event) {
            if (repoDropdownOpen && window.innerWidth > 768 && !event.target.closest('.repo-dropdown-container')) {
                toggleRepoDropdown();
            }
        });
        
        function hasRepoActivity(repo) {
            // Check if repo has any meaningful content
            const contentFields = [
                'overall_activity', 'brief_summary',
                'ongoing_projects', 'ongoing_summary',
                'new_features', 'new_features_summary',
                'notable_discussions', 'discussions_summary',
                'emerging_trends', 'trends_summary',
                'good_first_issues', 'issues_summary',
                'contributors', 'contributors_summary'
            ];
            
            return contentFields.some(field => {
                const value = repo[field];
                // Check for non-null, non-empty values
                if (!value || value.toString().trim() === '') return false;
                
                // Still filter out any "no activity" messages that slip through
                const lowerValue = value.toString().toLowerCase();
                const hasNoActivityPhrase = 
                    lowerValue.includes('no activity') ||
                    lowerValue.includes('no changes') ||
                    lowerValue.includes('no updates') ||
                    lowerValue.includes('quiet week') ||
                    lowerValue.includes('nothing to report');
                
                return !hasNoActivityPhrase;
            });
        }
        
        
        async function displayAllWeeks() {
            const display = document.getElementById('main-display');
            
            let weeks;
            if (currentEcosystem === 'all') {
                // For "all" ecosystem, show weeks from index that have weekly summaries or any group content
                weeks = indexData.weeks.filter(w => 
                    w.year === currentYear && (w.has_weekly_summary || w.groups.length > 0)
                );
            } else {
                weeks = groupsData[currentEcosystem].weeks.filter(w => {
                    const weekInfo = indexData.weeks.find(iw => iw.week === w.week && iw.year === currentYear);
                    return weekInfo && w.has_content;
                });
            }
            
            // First render week placeholders
            let html = '';
            weeks.forEach(week => {
                const weekInfo = indexData.weeks.find(w => w.week_key === week.week_key);
                html += renderWeekPlaceholder(week, weekInfo);
            });
            display.innerHTML = html;
            
            // Then load and render week content lazily with delays
            // Load weeks progressively to avoid blocking the UI
            weeks.forEach((week, index) => {
                setTimeout(async () => {
                    try {
                        const weekData = await loadWeekData(week.week_key);
                        if (weekData) {
                            await renderWeekContent(week.week_key, weekData);
                        }
                    } catch (error) {
                        console.error(`Failed to render week ${week.week_key}:`, error);
                    }
                }, index * 100); // Stagger loads by 100ms
            });
        }
        
        function renderWeekPlaceholder(week, weekInfo) {
            // Format the date range in words with year
            const formatWeekDate = (dateStr) => {
                const date = new Date(dateStr);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const day = date.getDate();
                const suffix = day === 1 || day === 21 || day === 31 ? 'st' : 
                              day === 2 || day === 22 ? 'nd' : 
                              day === 3 || day === 23 ? 'rd' : 'th';
                return `${day}${suffix} ${months[date.getMonth()]} ${date.getFullYear()}`;
            };
            
            const [startDate, endDate] = (week.week_range || weekInfo?.week_range || '').split(' to ');
            let formattedRange = '';
            if (startDate && endDate) {
                const startFormatted = formatWeekDate(startDate);
                const endFormatted = formatWeekDate(endDate);
                
                // If same month/year, don't repeat them
                const startParts = startFormatted.split(' ');
                const endParts = endFormatted.split(' ');
                formattedRange = startParts[1] === endParts[1] && startParts[2] === endParts[2] ? 
                    `${startParts[0]} - ${endParts[0]} ${endParts[1]} ${endParts[2]}` : 
                    `${startFormatted} - ${endFormatted}`;
            }
            
            return `
                <div class="week-section" id="week-${week.week_key}" data-week-key="${week.week_key}">
                    <div class="week-header-main">
                        <div class="week-title-main">
                            <div class="week-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                                </svg>
                            </div>
                            W${week.week}.${week.year}
                        </div>
                        <div class="week-date-range">${formattedRange}</div>
                    </div>
                    <div class="week-content">
                        <div class="loading-indicator">Loading week data...</div>
                    </div>
                </div>
            `;
        }
        
        async function renderWeekContent(weekKey, weekData) {
            const weekElement = document.getElementById(`week-${weekKey}`);
            if (!weekElement) return;
            
            const contentDiv = weekElement.querySelector('.week-content');
            if (!contentDiv) return;
                
            // Simply render the week content as it was originally - no extra repo summaries or lists
            contentDiv.innerHTML = generateWeekContent(weekData, currentEcosystem);
        }
        
        
        function generateWeekContent(weekData, ecosystem) {
            // Handle "all" ecosystem - show weekly summary
            if (ecosystem === 'all') {
                return generateWeeklySummaryContent(weekData);
            }
            
            const filteredGroups = weekData.group_summaries.filter(g => g.group === ecosystem);
            // Filter repos to only those in current ecosystem AND have actual content
            const filteredRepos = weekData.repositories.filter(repo => {
                if (!repo || !repo.repo_full) return false; // Skip empty or invalid entries
                if (!groupsData[currentEcosystem]) return false;
                if (!groupsData[currentEcosystem].repositories.includes(repo.repo_full)) return false;
                return hasRepoActivity(repo);
            });
            
            let leftColumn = '';
            let rightColumn = '';
            
            // Left column - Activity, Ongoing
            
            // Show group overview only for multi-repo ecosystems
            if (filteredRepos.length > 1) {
                filteredGroups.forEach(group => {
                    if (group.group_overview) {
                        leftColumn += `<div class="content-block">`;
                        leftColumn += `<div class="content-label">${getSectionIcon('overview')}overview</div>`;
                        leftColumn += `<div class="content-text">${renderMarkdown(group.group_overview)}</div>`;
                        leftColumn += `</div>`;
                    }
                });
            }
            
            const singleRepo = filteredRepos.length === 1;
            
            // New Features (FIRST - right after overview)
            const newFeaturesRepos = filteredRepos.filter(repo => repo.new_features || repo.new_features_summary);
            
            if (newFeaturesRepos.length > 0) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('new features')}new features</div>`;
                
                if (singleRepo && newFeaturesRepos[0].new_features_summary) {
                    leftColumn += `<div class="section-summary">${newFeaturesRepos[0].new_features_summary}</div>`;
                }
                
                newFeaturesRepos.forEach(repo => {
                    if (!singleRepo && repo.new_features_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.new_features_summary)}`;
                        leftColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.new_features) {
                        leftColumn += `<div class="content-text">${renderMarkdown(repo.new_features)}</div>`;
                    }
                });
                
                leftColumn += `</div>`;
            }
            
            // Repository activity summaries (SECOND - after new features)
            const activityRepos = filteredRepos.filter(repo => repo.brief_summary || repo.overall_activity);
            
            if (activityRepos.length > 0) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('activity')}activity</div>`;
                
                // Use brief_summary as section summary for single repo
                if (singleRepo && activityRepos[0].brief_summary) {
                    leftColumn += `<div class="section-summary">${activityRepos[0].brief_summary}</div>`;
                }
                
                activityRepos.forEach(repo => {
                    if (!singleRepo && repo.brief_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        // Integrate repo name into the summary text with commit range
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.brief_summary)}`;
                        leftColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.overall_activity) {
                        leftColumn += `<div class="content-text">${renderMarkdown(repo.overall_activity)}</div>`;
                    }
                });
                
                leftColumn += `</div>`;
            }
            
            // Ongoing projects (THIRD - after activity)
            const ongoingRepos = filteredRepos.filter(repo => repo.ongoing_projects || repo.ongoing_summary);
            
            if (ongoingRepos.length > 0) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('ongoing')}ongoing</div>`;
                
                if (singleRepo && ongoingRepos[0].ongoing_summary) {
                    leftColumn += `<div class="section-summary">${ongoingRepos[0].ongoing_summary}</div>`;
                }
                
                ongoingRepos.forEach(repo => {
                    if (!singleRepo && repo.ongoing_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.ongoing_summary)}`;
                        leftColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.ongoing_projects) {
                        leftColumn += `<div class="content-text">${renderMarkdown(repo.ongoing_projects)}</div>`;
                    }
                });
                
                leftColumn += `</div>`;
            }
            
            // Right column - Contributors, Discussions
            
            // Contributors (FOURTH)
            const contributorRepos = filteredRepos.filter(repo => repo.contributors || repo.contributors_summary);
            
            if (contributorRepos.length > 0) {
                rightColumn += `<div class="content-block">`;
                rightColumn += `<div class="content-label">${getSectionIcon('contributors')}contributors</div>`;
                
                if (singleRepo && contributorRepos[0].contributors_summary) {
                    rightColumn += `<div class="section-summary">${contributorRepos[0].contributors_summary}</div>`;
                }
                
                contributorRepos.forEach(repo => {
                    if (!singleRepo && repo.contributors_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.contributors_summary)}`;
                        rightColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.contributors) {
                        rightColumn += `<div class="contributor-text">${renderMarkdown(repo.contributors)}</div>`;
                    }
                });
                
                rightColumn += `</div>`;
            }
            
            // Notable discussions
            const discussionRepos = filteredRepos.filter(repo => repo.notable_discussions || repo.discussions_summary);
            
            if (discussionRepos.length > 0) {
                rightColumn += `<div class="content-block">`;
                rightColumn += `<div class="content-label">${getSectionIcon('discussions')}discussions</div>`;
                
                if (singleRepo && discussionRepos[0].discussions_summary) {
                    rightColumn += `<div class="section-summary">${discussionRepos[0].discussions_summary}</div>`;
                }
                
                discussionRepos.forEach(repo => {
                    if (!singleRepo && repo.discussions_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.discussions_summary)}`;
                        rightColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.notable_discussions) {
                        rightColumn += `<div class="content-text">${renderMarkdown(repo.notable_discussions)}</div>`;
                    }
                });
                
                rightColumn += `</div>`;
            }
            
            // Good first issues
            const issueRepos = filteredRepos.filter(repo => repo.good_first_issues || repo.issues_summary);
            
            if (issueRepos.length > 0) {
                rightColumn += `<div class="content-block">`;
                rightColumn += `<div class="content-label">entry points</div>`;
                
                if (singleRepo && issueRepos[0].issues_summary) {
                    rightColumn += `<div class="section-summary">${issueRepos[0].issues_summary}</div>`;
                }
                
                issueRepos.forEach(repo => {
                    if (!singleRepo && repo.issues_summary) {
                        const [org, name] = repo.repo_full.split('/');
                        const commitLink = getCommitRangeLink(repo);
                        const summaryWithRepo = `In <a href="https://github.com/${repo.repo_full}" target="_blank" class="repo-inline">${org}/${name}</a>${commitLink}: ${renderMarkdown(repo.issues_summary)}`;
                        rightColumn += `<div class="section-summary">${summaryWithRepo}</div>`;
                    }
                    
                    if (repo.good_first_issues) {
                        rightColumn += `<div class="content-text">${renderMarkdown(repo.good_first_issues)}</div>`;
                    }
                });
                
                rightColumn += `</div>`;
            }
            
            // If no content at all, return empty or minimal display
            if (!leftColumn && !rightColumn) {
                return '<div class="week-column"><div class="content-text" style="color: var(--text-dim); font-style: italic;">quiet week</div></div><div class="week-column"></div>';
            }
            
            if (!leftColumn) leftColumn = '';
            if (!rightColumn) rightColumn = '';
            
            return `
                <div class="week-column">${leftColumn}</div>
                <div class="week-column">${rightColumn}</div>
            `;
        }
        
        function generateWeeklySummaryContent(weekData) {
            const weeklySummary = weekData.weekly_summary;
            
            if (!weeklySummary) {
                // Fallback to showing all group summaries if no weekly summary
                let leftColumn = '';
                let rightColumn = '';
                
                // Show brief overview of all groups
                const allGroups = weekData.group_summaries || [];
                if (allGroups.length > 0) {
                    leftColumn += `<div class="content-block">`;
                    leftColumn += `<div class="content-label">${getSectionIcon('activity')}group activity</div>;`
                    
                    allGroups.forEach(group => {
                        if (group.brief_summary) {
                            leftColumn += `<div class="section-summary"><strong>${group.group}:</strong> ${renderMarkdown(group.brief_summary)}</div>`;
                        }
                    });
                    
                    leftColumn += `</div>`;
                }
                
                return `
                    <div class="week-column">${leftColumn}</div>
                    <div class="week-column">${rightColumn}</div>
                `;
            }
            
            let leftColumn = '';
            let rightColumn = '';
            
            // Left column - Overview, New Features, Cross-Repository Work, Key Projects
            if (weeklySummary.group_overview) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('overview')}overview</div>`;
                leftColumn += `<div class="content-text">${renderMarkdown(weeklySummary.group_overview)}</div>`;
                leftColumn += `</div>`;
            }
            
            // New Features - prominently placed after overview
            if (weeklySummary.new_features) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('new features')}new features</div>`;
                leftColumn += `<div class="content-text">${renderMarkdown(weeklySummary.new_features)}</div>`;
                leftColumn += `</div>`;
            }
            
            if (weeklySummary.cross_repository_work) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('cross-repo work')}cross-repo work</div>`;
                leftColumn += `<div class="content-text">${renderMarkdown(weeklySummary.cross_repository_work)}</div>`;
                leftColumn += `</div>`;
            }
            
            if (weeklySummary.key_projects) {
                leftColumn += `<div class="content-block">`;
                leftColumn += `<div class="content-label">${getSectionIcon('key projects')}key projects</div>`;
                leftColumn += `<div class="content-text">${renderMarkdown(weeklySummary.key_projects)}</div>`;
                leftColumn += `</div>`;
            }
            
            // Right column - Discussions, Trends
            
            if (weeklySummary.notable_discussions) {
                rightColumn += `<div class="content-block">`;
                rightColumn += `<div class="content-label">${getSectionIcon('discussions')}discussions</div>`;
                rightColumn += `<div class="content-text">${renderMarkdown(weeklySummary.notable_discussions)}</div>`;
                rightColumn += `</div>`;
            }
            
            if (weeklySummary.emerging_trends) {
                rightColumn += `<div class="content-block">`;
                rightColumn += `<div class="content-label">${getSectionIcon('emerging trends')}emerging trends</div>`;
                rightColumn += `<div class="content-text">${renderMarkdown(weeklySummary.emerging_trends)}</div>`;
                rightColumn += `</div>`;
            }
            
            // If no content at all, return empty
            if (!leftColumn && !rightColumn) {
                return '<div class="week-column"><div class="content-text" style="color: var(--text-dim); font-style: italic;">no weekly summary available</div></div><div class="week-column"></div>';
            }
            
            return `
                <div class="week-column">${leftColumn}</div>
                <div class="week-column">${rightColumn}</div>
            `;
        }
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.section-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '[-]';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '[+]';
            }
        }
        
        function updateStatus(message) {
            // Status updates are no longer displayed - function kept for compatibility
            console.log('Status:', message);
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
            updateStatus('ERROR STATE');
        }
        
        // Update repository view indicator
        function updateRepositoryViewIndicator(repoFullName) {
            const indicator = document.getElementById('repo-view-indicator');
            if (!indicator) return;
            
            if (repoFullName) {
                indicator.style.display = 'flex';
                indicator.innerHTML = `
                    <svg class="repo-icon" viewBox="0 0 16 16">
                        <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 0 1 1-1h8zM5 12.25v3.25a.25.25 0 0 0 .4.2l1.45-1.087a.25.25 0 0 1 .3 0L8.6 15.7a.25.25 0 0 0 .4-.2v-3.25a.25.25 0 0 0-.25-.25h-3.5a.25.25 0 0 0-.25.25z"/>
                    </svg>
                    <span>${repoFullName}</span>
                    <svg class="repo-close" viewBox="0 0 16 16">
                        <path d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.75.75 0 1 1 1.06 1.06L9.06 8l3.22 3.22a.75.75 0 1 1-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 0 1-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06z"/>
                    </svg>
                `;
                indicator.onclick = () => exitRepoView().catch(console.error);
            } else {
                indicator.style.display = 'none';
                indicator.innerHTML = '';
                indicator.onclick = null;
            }
        }
        
        // Populate timeline for repository view
        function populateRepoTimeline(repoData) {
            const timeline = document.querySelector('.timeline');
            console.log('Timeline element found:', !!timeline);
            if (!timeline) {
                console.error('Timeline element not found!');
                return;
            }
            
            let html = '';
            
            // Sort summaries by week (newest first) to match display order
            const sortedSummaries = repoData.summaries.sort((a, b) => {
                const keyA = `${a.year}-${String(a.week).padStart(2, '0')}`;
                const keyB = `${b.year}-${String(b.week).padStart(2, '0')}`;
                return keyB.localeCompare(keyA);
            });
            
            console.log('Populating timeline with', sortedSummaries.length, 'weeks');
            
            sortedSummaries.forEach(summary => {
                const weekKey = `${summary.year}-${String(summary.week).padStart(2, '0')}`;
                html += `
                    <div class="timeline-week" data-week-key="${weekKey}" onclick="scrollToWeek('${weekKey}')">
                        <div class="timeline-week-num">W${summary.week}</div>
                        <div class="timeline-week-year">${summary.year}</div>
                    </div>
                `;
            });
            
            timeline.innerHTML = html;
            console.log('Timeline populated with HTML length:', html.length);
        }
        
        // Setup scroll handler for repository view (same approach as main timeline)
        function setupRepoScrollHandler() {
            const mainContent = document.querySelector('.main-content');
            console.log('Setting up repo scroll handler, mainContent found:', !!mainContent);
            
            if (!mainContent) {
                console.error('Main content not found for repo scroll handler');
                return;
            }
            
            // Remove any existing scroll listeners
            mainContent.removeEventListener('scroll', updateTimelineHighlight);
            
            // Add repo-specific scroll listener
            const repoScrollHandler = () => {
                console.log('Repo scroll handler called, currentRepoView:', currentRepoView);
                if (!currentRepoView) {
                    console.log('Not in repo view, skipping');
                    return;
                }
                
                const weekSections = document.querySelectorAll('.week-section[data-week-key]');
                console.log('Week sections found in scroll handler:', weekSections.length);
                
                let visibleWeekKey = null;
                const mainRect = mainContent.getBoundingClientRect();
                console.log('Main content rect:', mainRect);
                
                weekSections.forEach((section, index) => {
                    const rect = section.getBoundingClientRect();
                    const weekKey = section.dataset.weekKey;
                    const isVisible = rect.top <= mainRect.top + 100 && rect.bottom > mainRect.top + 100;
                    
                    if (index < 3) { // Log first few for debugging
                        console.log(`Week ${weekKey}: top=${rect.top}, bottom=${rect.bottom}, mainTop=${mainRect.top}, visible=${isVisible}`);
                    }
                    
                    // Same logic as main timeline
                    if (isVisible) {
                        visibleWeekKey = weekKey;
                        console.log('Found visible week:', visibleWeekKey);
                    }
                });
                
                // Update if changed
                if (visibleWeekKey && currentWeekKey !== visibleWeekKey) {
                    console.log('Repo view - updating week from', currentWeekKey, 'to:', visibleWeekKey);
                    currentWeekKey = visibleWeekKey;
                    updateURL(true); // Use replaceState for scroll updates
                    
                    // Update timeline highlighting
                    document.querySelectorAll('.timeline-week').forEach(week => {
                        week.classList.remove('active');
                    });
                    
                    const activeWeek = document.querySelector(`.timeline-week[data-week-key="${visibleWeekKey}"]`);
                    if (activeWeek) {
                        activeWeek.classList.add('active');
                        console.log('Timeline week highlighted:', visibleWeekKey);
                    } else {
                        console.log('Could not find timeline week for:', visibleWeekKey);
                    }
                }
            };
            
            mainContent.addEventListener('scroll', repoScrollHandler);
            console.log('Repo scroll handler attached');
            
            // Store reference for cleanup
            mainContent._repoScrollHandler = repoScrollHandler;
        }
        
        // Clean up repo scroll handler when exiting repo view
        function cleanupRepoScrollHandler() {
            const mainContent = document.querySelector('.main-content');
            if (mainContent && mainContent._repoScrollHandler) {
                mainContent.removeEventListener('scroll', mainContent._repoScrollHandler);
                delete mainContent._repoScrollHandler;
                console.log('Repo scroll handler cleaned up');
                
                // Restore main timeline scroll handler
                mainContent.addEventListener('scroll', () => {
                    updateTimelineHighlight();
                });
                console.log('Main timeline scroll handler restored');
            }
        }
        
        // Handle browser back/forward navigation
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.repo) {
                showRepoSummary(event.state.repo).catch(console.error);
            } else {
                if (currentRepoView) {
                    exitRepoView().catch(console.error);
                }
            }
        });
        
        // Check URL parameters on page load
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const repoParam = urlParams.get('repo');
            const weekParam = urlParams.get('week');
            
            // Set current week if provided
            if (weekParam) {
                currentWeekKey = weekParam;
            }
            
            if (repoParam) {
                // Wait for data to load, then show repository
                setTimeout(() => {
                    showRepoSummary(repoParam).catch(console.error);
                }, 500); // Give more time for initialization
            }
        }
        
        // Feeds modal functions
        function generateDynamicGroups() {
            const headerGroups = document.getElementById('header-groups');
            if (!headerGroups || !groupsData) return;
            
            // Check if groups have already been added (to prevent duplicates)
            if (headerGroups.dataset.generated === 'true') return;
            headerGroups.dataset.generated = 'true';
            
            // Get existing ALL tab
            const allTab = headerGroups.querySelector('[data-group="all"]');
            
            // Create mobile abbreviations CSS dynamically
            const mobileAbbreviations = {
                'ecosystem': 'ECO',
                'oxcaml': 'OX'
            };
            
            // Add dynamic CSS for mobile abbreviations
            const style = document.createElement('style');
            let mobileCSS = '';
            
            // Add group tabs dynamically (excluding 'all' which is already there)
            Object.keys(groupsData).forEach(groupKey => {
                if (groupKey !== 'all') {
                    // Check if this group tab already exists
                    if (headerGroups.querySelector(`[data-group="${groupKey}"]`)) return;
                    
                    const tab = document.createElement('div');
                    tab.className = 'group-tab';
                    tab.dataset.group = groupKey;
                    tab.textContent = `[${groupKey.toUpperCase()}]`;
                    tab.onclick = () => {
                        if (currentRepoView) {
                            exitRepoView().then(() => switchGroup(groupKey)).catch(console.error);
                        } else {
                            switchGroup(groupKey).catch(console.error);
                        }
                    };
                    headerGroups.appendChild(tab);
                    
                    // Add mobile abbreviation CSS if group name is long
                    if (groupKey.length > 5 || mobileAbbreviations[groupKey]) {
                        const abbrev = mobileAbbreviations[groupKey] || 
                                      groupKey.substring(0, 3).toUpperCase();
                        mobileCSS += `
                            @media screen and (max-width: 768px) {
                                .group-tab[data-group="${groupKey}"] {
                                    font-size: 0;
                                }
                                .group-tab[data-group="${groupKey}"]::after {
                                    content: "[${abbrev}]";
                                    font-size: 10px;
                                }
                            }
                        `;
                    }
                }
            });
            
            if (mobileCSS) {
                style.textContent = mobileCSS;
                document.head.appendChild(style);
            }
            
            // Re-add click handler for ALL tab
            if (allTab) {
                allTab.onclick = () => switchGroup('all').catch(console.error);
            }
            
            // Add dynamic feed links to head
            const head = document.head;
            Object.keys(groupsData).forEach(groupKey => {
                if (groupKey !== 'all') {
                    const link = document.createElement('link');
                    link.rel = 'alternate';
                    link.type = 'application/atom+xml';
                    link.title = `OCaml ${groupKey.charAt(0).toUpperCase() + groupKey.slice(1)}`;
                    link.href = `feeds/${groupKey}.xml`;
                    head.appendChild(link);
                }
            });
        }
        
        function generateDynamicFeeds() {
            const modalBody = document.getElementById('feeds-modal-body');
            if (!modalBody || !groupsData) return;
            
            // Keep the weekly feed (first item)
            const weeklyFeed = modalBody.querySelector('.feed-item-link');
            modalBody.innerHTML = '';
            if (weeklyFeed) {
                modalBody.appendChild(weeklyFeed);
            }
            
            // Add group feeds dynamically
            Object.keys(groupsData).forEach(groupKey => {
                if (groupKey !== 'all') {
                    const groupName = groupKey.charAt(0).toUpperCase() + groupKey.slice(1);
                    const groupDesc = getGroupDescription(groupKey);
                    
                    const feedLink = document.createElement('a');
                    feedLink.href = `feeds/${groupKey}.xml`;
                    feedLink.className = 'feed-item-link';
                    feedLink.target = '_blank';
                    feedLink.title = `Subscribe to ${groupName} Feed`;
                    
                    feedLink.innerHTML = `
                        <div class="feed-item">
                            <div class="feed-info">
                                <div class="feed-title">${groupName}</div>
                                <div class="feed-desc">${groupDesc}</div>
                            </div>
                            <div class="feed-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 11a9 9 0 0 1 9 9"/>
                                    <path d="M4 4a16 16 0 0 1 16 16"/>
                                    <circle cx="5" cy="19" r="1"/>
                                </svg>
                            </div>
                        </div>
                    `;
                    
                    modalBody.appendChild(feedLink);
                }
            });
        }
        
        function getGroupDescription(groupKey) {
            const descriptions = {
                'core': 'OCaml compiler and runtime updates',
                'tools': 'Build systems, package managers, and developer tools',
                'ecosystem': 'Libraries, frameworks, and community projects',
                'oxcaml': 'Jane Street and extended ecosystem'
            };
            return descriptions[groupKey] || `${groupKey.charAt(0).toUpperCase() + groupKey.slice(1)} repositories`;
        }
        
        async function switchGroup(groupName) {
            // Update active tab styling
            document.querySelectorAll('.group-tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.group === groupName) {
                    t.classList.add('active');
                }
            });
            
            // Switch ecosystem and refresh content
            currentEcosystem = groupName;
            populateTimeline();
            await displayAllWeeks();
            updateURL();
        }
        
        function showFeeds() {
            const modal = document.getElementById('feeds-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeFeeds() {
            const modal = document.getElementById('feeds-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Initialize on load
        initTheme();
        initSystem();
        
        // Set up modal event listener after DOM loads
        window.addEventListener('load', function() {
            const feedsModal = document.getElementById('feeds-modal');
            if (feedsModal) {
                feedsModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeFeeds();
                    }
                });
            }
        });
        
        // Lazy load user avatars on hover
        function initLazyAvatars() {
            document.addEventListener('mouseover', function(event) {
                // Check if hovering over a user link
                const userLink = event.target.closest('.user-link');
                if (!userLink) return;
                
                // Find the tooltip avatar within the parent wrapper
                const wrapper = userLink.closest('.user-link-wrapper');
                if (!wrapper) return;
                
                const lazyImg = wrapper.querySelector('img[data-lazy="true"]');
                if (!lazyImg) return;
                
                // Load the avatar if not already loaded
                if (lazyImg.dataset.src && !lazyImg.src) {
                    lazyImg.src = lazyImg.dataset.src;
                    lazyImg.removeAttribute('data-lazy');
                    lazyImg.removeAttribute('data-src');
                }
            });
        }
        
        // Initialize lazy avatars and system on page load
        window.addEventListener('DOMContentLoaded', () => {
            initSystem();
            initLazyAvatars();
        });
    </script>
    
    <!-- Feeds Modal -->
    <div id="feeds-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">RSS/Atom Feeds</span>
                <span class="modal-close" onclick="closeFeeds()">&times;</span>
            </div>
            <div class="modal-body" id="feeds-modal-body">
                <!-- Feed items will be dynamically added here -->
                <a href="feeds/weekly.xml" class="feed-item-link" target="_blank" title="Subscribe to Weekly Feed">
                    <div class="feed-item">
                        <div class="feed-info">
                            <div class="feed-title">Weekly Summaries</div>
                            <div class="feed-desc">All ecosystem activity aggregated weekly</div>
                        </div>
                        <div class="feed-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 11a9 9 0 0 1 9 9"/>
                                <path d="M4 4a16 16 0 0 1 16 16"/>
                                <circle cx="5" cy="19" r="1"/>
                            </svg>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</body>
</html>
